<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    
  </head>
<style>
/*
*
* ==========================================
* CUSTOM UTILITY CLASSES
* ==========================================
*
*/

    
    
.btn:focus {
  outline: none;
  box-shadow: none;
}
  
.custom {
    width: 160px !important;
      margin-bottom: 10px !important;
       margin-top: 10px !important;
}
  
.custom1 {
    width: 190px !important;
     margin-bottom: 10px;
       margin-top: 10px;
}

.jumbotron{
    margin-bottom: 0;
  }
    
html,body{
  width:100%;
  height:100%;
  margin:0;
  padding:0:
}
.navbar{
  width:100%;
  margin:0;
  padding:0;
  background-color:green;
  height:50px;
}
.imageH{
  width:100%;
  margin:0;
  padding:0;
  background-image:url("europe.jpg");
  background-size:cover;
  background-position:center;
  height:calc(100vh - 50px);
}
    
.footer {
    position: fixed;
    height: 60px;
    bottom: 0;
    width: 100%;
    background-color: #f5f5f5;
}
.alert {
 display:inline-block;
    font-size: 10px;

}
    
</style>
<body>

    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>

    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
    <link href='https://fonts.googleapis.com/css?family=Orbitron' rel='stylesheet' type='text/css'>
    <!-- <script src="jquery.slim.min.js"></script> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="gauge.min.js"></script>
    <script type="text/javascript" src="segment-display.js"></script>
    
<script type="text/javascript">
    


var display = new SegmentDisplay("display");
      display.pattern         = "###";
      display.displayAngle    = 0.5;
      display.digitHeight     = 20;
      display.digitWidth      = 12;
      display.digitDistance   = 2.5;
      display.segmentWidth    = 2.5;
      display.segmentDistance = 0.5;
      display.segmentCount    = 7;
      display.cornerType      = 3;
      display.colorOn         = "rgba(255, 255, 255, 0.9)";
      display.colorOff        = "rgba(0, 0, 0, 0.1)";
      display.value           = 0;
      display.draw();
       
// websocket connect info - define fuctip to obtain websocket ip on the fly
var url = "ws://192.168.178.85:1337/";
//var output;
var button_brake;
var button_cw;
var button_ccw;
var context;
var endstop;
    
var res;
var old_res;
var res_stop
res_stop = 0;
var Starting_App
Starting_App = 0;
    


// This is called when the page finishes loading
function init() {
    // Assign page elements to variables
    button_brake = document.getElementById("button_brake");
    button_cw = document.getElementById("button_cw");
    button_ccw = document.getElementById("button_ccw");
    // Connect to WebSocket server
    wsConnect();
}
 
// Call to connect to the WebSocket server
function wsConnect() {
        // Connect to WebSocket server
        websocket = new WebSocket(url);
        //websocket = new WebSocket(((window.location.protocol === "https:") ? "wss://" : "ws://") + window.location.host + ":1337");
        websocket.onopen = function(evt) { onOpen(evt) };
        websocket.onmessage = function(evt) { onMessage(evt) };
        websocket.onclose = function(evt) { onClose(evt) };
        websocket.onerror = function(evt) { onError(evt) };
        button_brake.disabled = true;
        button_cw.disabled = true;
        button_ccw.disabled = true;
        document.getElementById("display_info").innerHTML = "Web Rotor is initiated";
}
 
// Called when a WebSocket connection is established with the server
function onOpen(evt) {

        // Log connection state
        console.log("Connected to the rotor server");
        document.getElementById("display_info").innerHTML = "Web Rotor receiving data";
        // Get the current position from the rotor
        //doSend("getBEARINGState"); 
        doSend("getBRAKEState");
        doSend("getCWState");
        doSend("getCCWState");
        //Enable the buttons
        button_brake.disabled = false;
        button_cw.disabled = false;
        button_ccw.disabled = false;        
}

// Called when the WebSocket connection is closed
function onClose(evt) {
    // Log disconnection state
    // console.log("Disconnected");
    document.getElementById("display_info").innerHTML = "Rotor disconnected, retrying";
    // display.setValue('000');
    // Try to reconnect after a few seconds
    wsConnect(url);
}
 
// Called when a message is received from the server
function onMessage(evt) {
var gaugeElement = document.getElementsByTagName('canvas')[0];
        // Print out our received message
         // cinstruct the bearing value from the string received
        res = evt.data.substr(0, 9);
        res_msg = evt.data.substr(0, 9);
        //console.log("Received string  |" + evt.data+"|");
        //console.log("Received message |" + res_msg+"|");

         if (res == "Bearing :") {
                document.getElementById("display").innerHTML = "Rotor receiving bearing data";
                res = evt.data.substr(9, 3);
                console.log(res);
                if ((res_stop =1) && (res <359) && (res > 1)){    
                }
                          if (Starting_App == 0){  
                            console.log("Allowing data to come.");
                            Starting_App = 1;
                            old_res = res;
                            doSend("StartBearing"); 
                            
                            } else {
                            display.setValue(res);
                            //data-value=res;  
                            //var gaugeElement = document.getElementsByTagName('canvas')[0];
                            gaugeElement.setAttribute('data-value', res);
                            endstop = res;
                            
                            }
               
         }
    

switch(evt.data) {
// Spare switch or LED
        case "0":
        //
        case "1":
        //
            
// CW switch
        case "2":
            console.log("CW switch is switched to ON");
           
            document.getElementById("button_ccw").innerHTML='CCW OFF  <span class="s" role="status" aria-hidden="true"></span>';
            document.getElementById("button_cw").innerHTML='CW ON   <span class="spinner-border spinner-border float-right" role="status" aria-hidden="true"></span>';
            break;
            
         case "3":
            console.log("CW switch is switched to OFF");
            document.getElementById("button_cw").innerHTML='CW OFF   <span class="" role="status" aria-hidden="true"></span>'; 
            break;  
      
        case "4":

            console.log("CCW switch is switched to ON");
            document.getElementById("button_cw").innerHTML='CW OFF   <span class="s" role="status" aria-hidden="true"></span>';
           

            document.getElementById("button_ccw").innerHTML='CCW ON  <span class="spinner-border spinner-border float-right " role="status" aria-hidden="true"></span>';
            break;
   
  
        case "5":
            console.log("CCW switch is is switched to OFF");
            document.getElementById("button_ccw").innerHTML='CCW OFF  <span class="" role="status" aria-hidden="true"></span>'; 
            break;  
  

// BRAKE switch
       case "6":
           var cw_status;
            cw_status = document.getElementById("button_cw").innerText;
            if (cw_status == "CW ON"){
            doSend("toggleCW");
            doSend("getCWState");
            //console.log("CW switch is switched to OFF");
            document.getElementById("button_cw").innerHTML='CW OFF<span class="s" role="status" aria-hidden="true"></span>'   
            }
            var ccw_status;
            ccw_status = document.getElementById("button_ccw").innerText;
            if (ccw_status == "CCW ON"){
            doSend("toggleCCW");
            doSend("getCCWState");
            //console.log("CCW switch is switched to OFF");
            document.getElementById("button_ccw").innerHTML='CCW OFF;';
            }
            //console.log("Brake is is switched to ON");    
            document.getElementById("button_brake").innerHTML = "BRAKE ON";
            button_cw.disabled = true;
            button_ccw.disabled = true;
            break;
         case "7":
            console.log("Brake is switched to OFF");
            document.getElementById("button_brake").innerHTML = "BRAKE OFF";
            button_cw.disabled = false;
            button_ccw.disabled = false;
            break;


        case "99":
            //console.log("Plate should be switched to red");  
            res_stop = 1;
            break;
        default:
            break;
    }
}


// Called when a WebSocket error occurs
function onError(evt) {
    //console.log("ERROR: " + evt.data);
       document.getElementById("display_info").innerHTML = "Unknow error, please reload page";

}
 
// Sends a message to the server (and prints it to the console)
function doSend(message) {
    //console.log("Sending: " + message);
    websocket.send(message);
}
 
// executes all necessary action when one of the sw switches is pressed      
function onPressButton(x) {
    switch(x){
        case 1:
                if (endstop > 358) {
                //console.log("Going CW with rotorvalue: " + endstop);
                document.getElementById("display_info").innerHTML = "CW Endstop reached!";
                } else {
                document.getElementById("display_info").innerHTML = "Rotor receiving bearing data";
                doSend("toggleCW");
                doSend("getCWState");
                }
            break;
        case 2:
            if (endstop <= 2) {
               //console.log("Going CCW with rotorvalue: " + endstop);
                document.getElementById("display_info").innerHTML = "CCW endstop reached!";
            } else {
                document.getElementById("display_info").innerHTML = "Rotor receiving bearing data";
                doSend("toggleCCW");
                doSend("getCCWState");
            }
             break;
        case 3:
            doSend("toggleBRAKE");
            doSend("getBRAKEState");
            
            break;
       case 4:

            break;
       default:
            break;         
    }
}
         
function GetRotorBearing()
		{
          doSend("getBEARINGState"); 
          //console.log("BEARING value requested");
		}
    
// Call the init function as soon as the page loads
window.addEventListener("load", init, false);
 
</script>
 
    
<body>
<div class="imageH">
         <!-- Navigation -->
      <nav class="navbar navbar-expand-lg navbar-dark bg-dark static-top">
        <div class="container-fluid">
          <a class="navbar-brand" href="#">Web Rotor Controller</a>
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarResponsive">
            <ul class="navbar-nav ml-auto">
              <li class="nav-item active">
                <a class="nav-link" href="#">Home
                  <span class="sr-only">(current)</span>
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="update">Update OTA</a>
              </li>
            </ul>
          </div>
        </div>
      </nav>    


    <div class="container-fluid">
        <div class="col-sm text-center">  
            <br>
            <center>
<canvas data-type="radial-gauge"
        data-width="300"
        data-height="300"
        data-min-value="0"
        data-max-value="360"
        data-major-ticks="N,NO,O,ZO,Z,ZW,W,NW,N"
        data-minor-ticks="22"
        data-ticks-angle="360"
        data-start-angle="180"
        data-stroke-ticks="false"
        data-highlights="false"
        data-color-plate="#000000"
        data-color-major-ticks="#f5f5f5"
        data-color-minor-ticks="#ddd"
        data-color-numbers="#ccc"
        data-color-needle="rgba(240, 128, 128, 1)"
        data-color-needle-end="rgba(255, 160, 122, .9)"
        data-value-box="false"
        data-value-text-shadow="false"
        data-color-circle-inner="#fff"
        data-color-needle-circle-outer="#ccc"
        data-needle-circle-size="15"
        data-needle-circle-outer="false"
        data-animation-rule="linear"
        data-needle-type="arrow"
        data-needle-start="20"
        data-needle-end="99"
        data-needle-width="4"
        data-borders="true"
        data-border-inner-width="0"
        data-border-middle-width="0"
        data-border-outer-width="10"
        data-color-border-outer="#ccc"
        data-color-border-outer-end="#ccc"
        data-color-needle-shadow-down="#222"
        data-border-shadow-width="0"
        data-units="PA0ESH"
        data-title="ANTENNA BEARING"
        data-font-title-size="19"
        data-color-title="#f5f5f5"
        data-animation-duration="1800"
        data-value="0"
        data-animate-on-init="true"
        
></canvas>


            </center>
        </div>
    </div>


    <div class="container-fluid">
        <div class="row">
            <div class="col-sm text-center">
                <!--<button onclick="showLoc();">Show location properties</button> -->
                
                <center>
                         
                        <canvas id="display" width="120" height="34" align = "right"></canvas>
                        
                    </center>
                      
  
                    <div class="btn-group-vertical" align="center" role="group" aria-label="" style="padding-bottom: 15px;">
                        <div class="alert alert-light custom1" role="alert" id = "display_info">.....</div>
                      <button type="button" class="btn btn-primary btn-lg custom1" id="button_ccw" onclick="onPressButton(2)">CCW OFF</button>
                        <button type="button" class="btn btn-primary btn-lg custom1" id="button_cw" onclick="onPressButton(1)">CW OFF</button>
                        <button type="button" class="btn btn-danger custom1 btn-lg" data-toggle="popover" id="button_brake" onclick="onPressButton(3)">BRAKE OFF</button> 
                    </div>
                 
             </div>
        </div>
    </div>
</div>
        
               <!-- Footer -->
        <footer id="sticky-footer" class="py-4 bg-dark text-white-50">
            <div class="container text-center" >
            <small>GNU licence &copy; 2020 PA0ESH - V1.5</small>
            </div>
      </footer>
    
<script>
var x = document.getElementById("demo");

function getLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(showPosition, showError);
  } else { 
    x.innerHTML = "Geolocation is not supported by this browser.";
  }
}

function showPosition(position) {
  x.innerHTML = "Latitude: " + position.coords.latitude + 
  "<br>Longitude: " + position.coords.longitude;
}

function showError(error) {
  switch(error.code) {
    case error.PERMISSION_DENIED:
      x.innerHTML = "User denied the request for Geolocation."
      break;
    case error.POSITION_UNAVAILABLE:
      x.innerHTML = "Location information is unavailable."
      break;
    case error.TIMEOUT:
      x.innerHTML = "The request to get user location timed out."
      break;
    case error.UNKNOWN_ERROR:
      x.innerHTML = "An unknown error occurred."
      break;
  }
}
</script>


    </body>
</html>
